{% extends 'base.html' %}

{% block title %}Dashboard - SIPDE{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- === INICIO: Formulario de Selección de Periodo === -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Dashboard de Riesgo</h1>
        <form method="get" class="d-flex align-items-center">
            <label for="periodo-select" class="form-label me-2 mb-0">Periodo:</label>
            <select name="periodo" id="periodo-select" class="form-select w-auto" onchange="this.form.submit()">
                {% for periodo in periodos_disponibles %}
                    <option value="{{ periodo }}" {% if periodo == periodo_seleccionado %}selected{% endif %}>
                        {{ periodo }}
                    </option>
                {% empty %}
                    <option>No hay periodos</option>
                {% endfor %}
            </select>
        </form>
    </div>
    <!-- === FIN: Formulario de Selección de Periodo === -->
    
    <!-- Fila de Métricas Clave -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card card-metric border-primary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary">Estudiantes Analizados</h5>
                    <p class="card-text fs-2 fw-bold">{{ total_estudiantes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-metric border-danger shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-danger">En Riesgo Alto</h5>
                    <p class="card-text fs-2 fw-bold">{{ riesgo_alto_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-metric border-success shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-success">Tasa de Permanencia</h5>
                    <p class="card-text fs-2 fw-bold">{{ tasa_retencion }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Fila de Gráficos -->
    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Riesgo por Semestre de Antigüedad</div>
                <div class="card-body">
                    <canvas id="riskBySemesterChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Distribución de Riesgo</div>
                <div class="card-body">
                    <canvas id="riskDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        try {
            const distribucionData = JSON.parse('{{ chart_distribucion_data|safe }}');
            const antiguedadData = JSON.parse('{{ chart_antiguedad_data|safe }}');

            // --- Gráfico de Dona: Distribución de Riesgo ---
            const ctxDoughnut = document.getElementById('riskDistributionChart');
            if (ctxDoughnut && distribucionData.data && distribucionData.data.some(d => d > 0)) {
                new Chart(ctxDoughnut.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: distribucionData.labels,
                        datasets: [{
                            data: distribucionData.data,
                            backgroundColor: ['rgba(220, 53, 69, 0.7)', 'rgba(25, 135, 84, 0.7)'],
                            borderColor: ['rgba(220, 53, 69, 1)', 'rgba(25, 135, 84, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            // --- Gráfico de Barras: Riesgo por Semestre de Antigüedad ---
            const ctxBar = document.getElementById('riskBySemesterChart');
            if (ctxBar && antiguedadData.data && antiguedadData.data.length > 0) {
                new Chart(ctxBar.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: antiguedadData.labels,
                        datasets: [{
                            label: '# de Estudiantes en Riesgo',
                            data: antiguedadData.data,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

        } catch (e) {
            console.error("Error al inicializar los gráficos:", e);
        }
    });
</script>
{% endblock %}
